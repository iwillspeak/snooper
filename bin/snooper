#! /usr/bin/env ruby

# Author::    Will Speak  (@willspeak)
# Copyright:: Copyright (c) 2013 Will Speak
# License::   Snoop is open source! See LICENCE.md for more details.

require 'snooper'
require 'colored'

##
# Main program loop
#
# Do our stuff, and exit cleanly when interrupted.

def test_loop(options)
  begin
    dirs = options[:dirs] ? options[:dirs] : './'
    Snooper.watch dirs, options 
  rescue Interrupt
    puts # This is where the ^C is on unix
    puts "Done".yellow
  end
end



# TODO: load the options from the arguments
options = {
  :base_dir => ARGV.shift,
  :command => (ARGV.shift or "echo 'no tests to run :-)'"),
  :filters => %w{\.c \.h \.mk},
  :exclude => %w{build/ bin/}
}

old_dir = Dir.expand_path '.'
Dir.chdir options[:base_dir] if options[:base_dir]

test_loop options

Dir.chdir old_dir