#! /usr/bin/env ruby

# Author::    Will Speak  (@willspeak)
# Copyright:: Copyright (c) 2013 Will Speak
# License::   Snoop is open source! See LICENCE.md for more details.

require 'snooper'
require 'colored'

##
# Internal: Main program loop
#
# config - the hash containing the options.
#
# Do our stuff, and exit cleanly when interrupted.
#
# Returns nothing.
def test_loop(options)
  Snooper.watch options
rescue Interrupt
  puts # This is where the ^C is on unix
  puts "Testing over, time for a coffee...".yellow
end

options = Snooper::Options.parse ARGV

begin
  config = Snooper::Config.load options.config_path
rescue Exception => error
  $stdout.puts "#{$0}: error: couldn't load '#{options.config_path}' (#{error})"
  exit 1
end

# Override the command if one was specified
config.command = options.command if options.command

# Force polling if command line flag is set
config.force_poll = options.poll if options.poll

# Run the tests, pusing the target directory
test_loop config
